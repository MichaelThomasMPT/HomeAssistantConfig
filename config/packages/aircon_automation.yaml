script:
  #Turn off all zones
  aircon_turn_off_all_zones:
    sequence:
    - data:
        entity_id: 
          - cover.bed_2_3
          - cover.living
          - cover.master_bed
          - cover.theatre
      service: cover.close_cover

  #Warm the master bedroom for 60 minutes
  aircon_warm_master:
    sequence:
    - data:
        entity_id: climate.ac
        temperature: 25
      service: climate.set_temperature
    - data:
        entity_id: climate.ac
        hvac_mode: heat
      service: climate.set_hvac_mode
    - data:
        entity_id: climate.ac
      service: climate.turn_on
    - service: script.aircon_turn_off_all_zones
    - data:
        entity_id: cover.master_bed
      service: cover.open_cover
    - delay:
        seconds: 10
    - data:
        entity_id: input_number.aircon_countdown_timer
        value: 30
      service: input_number.set_value
    alias: Aircon Warm Master
    
  #Run the fan in the master bedroom for 60 minutes
  aircon_fan_master:
    sequence:
    - data:
        entity_id: climate.ac
        hvac_mode: fan_only
      service: climate.set_hvac_mode
    - service: script.aircon_turn_off_all_zones
    - data:
        entity_id: cover.master_bed
      service: cover.open_cover
    - delay:
        seconds: 10
    - data:
        entity_id: input_number.aircon_countdown_timer
        value: 60
      service: input_number.set_value
    alias: Aircon Fan Master
    
  #Run the aircon in the central living area
  aircon_cool_central_living:
    sequence:
    - data:
        entity_id: climate.ac
        temperature: 21
      service: climate.set_temperature
    - data:
        entity_id: climate.ac
        hvac_mode: cool
      service: climate.set_hvac_mode
    - service: script.aircon_turn_off_all_zones
    - data:
        entity_id: cover.living
      service: cover.open_cover
    alias: Aircon Cool Central Living

  #Run the aircon in the theatre room
  aircon_cool_theatre:
    sequence:
    - data:
        entity_id: climate.ac
        temperature: 23
      service: climate.set_temperature
    - data:
        entity_id: climate.ac
        hvac_mode: cool
      service: climate.set_hvac_mode
    - service: script.aircon_turn_off_all_zones
    - data:
        entity_id: cover.theatre
      service: cover.open_cover
    alias: Aircon Cool Theatre

  #Run the aircon in cool mode
  aircon_cool:
    sequence:
    - data:
        entity_id: climate.ac
        temperature: 21
      service: climate.set_temperature
    - data:
        entity_id: climate.ac
        hvac_mode: cool
      service: climate.set_hvac_mode
    alias: Aircon On
    
  #Run the aircon in heat mode
  aircon_heat:
    sequence:
    - data:
        entity_id: climate.ac
        temperature: 24
      service: climate.set_temperature
    - data:
        entity_id: climate.ac
        hvac_mode: heat
      service: climate.set_hvac_mode
    - data:
        entity_id: climate.ac
      service: climate.turn_on
    alias: Heater On

  #Save the current aircon state, blast aircon for 10 min, then restore state.
  aircon_blast_cold_for_ten_minutes:
    sequence:
      - service: scene.create
        data:
          scene_id: aircon_saved_state
          snapshot_entities:
            - climate.ac
      - data:
          entity_id: climate.ac
          temperature: 21
          hvac_mode: cool
        service: climate.set_temperature
      - data:
          entity_id: climate.ac
          hvac_mode: cool
        service: climate.set_hvac_mode
      - delay:
          minutes: 10
      - service: scene.turn_on
        data:
          entity_id: scene.aircon_saved_state
          
automation:
  - alias: Temperature - Morning Warmth
    trigger:
      - platform: time
        at: '06:00:00'
    condition:
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
      - condition: numeric_state
        entity_id: sensor.master_bedroom_temperature
        below: '16.5'
        value_template: '{{ state.attributes.temperature }}'
    action:
      - service: script.aircon_warm_master

  - alias: Temperature - Solar Cooling
    trigger:
      platform: time_pattern
      minutes: "/1" #This will match every 1 minutes
    condition:
      - condition: template
        value_template: '{{ (states.sensor.living_room_temperature.state | float) > 25.0 }}' #if the inside temperature is > 25 degrees  
      - condition: template
        value_template: '{{ (states.sensor.sems_output_power.state | float) > 2000.0 }}' #if the solar panels are running well
      - condition: state
        entity_id: 'alarm_control_panel.alarm_com'
        state: 'armed_away' #nobody is home
      - condition: state
        entity_id: 'switch.aircon_on_off'
        state: 'off' #don't run the script if the aircon is already on, as it will restart the countdown timer
    action:
      - service: script.aircon_cool_central_living #run the aircon in the central living area
      - delay: #wait until it's up and running
          seconds: 30 
      - service: input_number.set_value #stop the aircon after 15 minutes
        data_template: 
          entity_id: input_number.aircon_countdown_timer
          value: 15

  - alias: Temperature - Master Bed Button Trigger - Fan
    trigger:
      - platform: event
        event_type: deconz_event
        event_data: 
          id: master_bed_switch_1
          event: 1002
      - platform: event
        event_type: deconz_event
        event_data: 
          id: master_bed_switch_2
          event: 1002
    condition:
      - condition: template
        value_template: '{{ (states.sensor.master_bedroom_temperature.state | float) > 22.0 }}' 
      - condition: state
        entity_id: 'switch.aircon_on_off'
        state: 'off' #aircon is currently off
    action:
      - service: script.aircon_fan_master 

  - alias: Temperature - Master Bed Button Trigger - Warm
    trigger:
      - platform: event
        event_type: deconz_event
        event_data: 
          id: master_bed_switch_1
          event: 1002
      - platform: event
        event_type: deconz_event
        event_data: 
          id: master_bed_switch_2
          event: 1002
    condition:
      - condition: template
        value_template: '{{ (states.sensor.master_bedroom_temperature.state | float) <= 22.0 }}' 
      - condition: state
        entity_id: 'switch.aircon_on_off'
        state: 'off' #aircon is currently off
    action:
      - service: script.aircon_warm_master 

  - alias: Temperature - Master Bed Button Trigger - Off
    trigger:
      - platform: event
        event_type: deconz_event
        event_data: 
          id: master_bed_switch_1
          event: 1002
      - platform: event
        event_type: deconz_event
        event_data: 
          id: master_bed_switch_2
          event: 1002
    action:
      - service: climate.turn_off
        data:
          entity_id: climate.ac
