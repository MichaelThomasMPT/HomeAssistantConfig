light:
  - platform: switch
    name: Alfresco Fairy Lights - Ceiling
    entity_id: switch.alfresco_fairy_lights_ceiling
  - platform: switch
    name: Alfresco Fairy Lights - Wall
    entity_id: switch.alfresco_fairy_lights_wall
  - platform: template
    lights:
      alfresco_fairy_lights:
        icon_template: mdi:string-lights
        friendly_name: "Alfresco Fairy Lights"
        value_template: "{{ states('light.alfresco_fairy_lights_ceiling') == 'on' or states('light.alfresco_fairy_lights_wall') == 'on'}}"
        turn_on:
          service: light.turn_on
          entity_id:
            - light.alfresco_fairy_lights_ceiling
            - light.alfresco_fairy_lights_wall
        turn_off:
          service: light.turn_off
          entity_id:
            - light.alfresco_fairy_lights_ceiling
            - light.alfresco_fairy_lights_wall

automation:
  - alias: Garden - Turn On Outdoor Lights When Both Back Doors Are Opened
    id: garden_turn_on_outdoor_lights_when_both_back_doors_are_opened
    trigger: 
      - platform: state
        entity_id: 
          - binary_sensor.back_door_glass
          - binary_sensor.back_door_flyscreen
        to: 'on' #open
    condition:
      condition: and
      conditions:
        - condition: state  # from sunset until sunrise
          entity_id: sun.sun
          state: 'below_horizon'
        - condition: state
          entity_id: 'binary_sensor.back_door_glass'
          state: 'on' #open
        - condition: state
          entity_id: 'binary_sensor.back_door_flyscreen'
          state: 'on' #open
        - condition: state
          entity_id: 'light.alfresco_ceiling_lights' #Don't turn on the fairy lights if the ceiling lights are already on; don't need both active! 
          state: 'off'
    action:
      - service: light.turn_on
        entity_id: light.alfresco_fairy_lights
        data:
          brightness_pct: 100

 #if garden lights left on during the day, turn them off.
  - alias: Garden - Turn Off Outdoor Lights If Left On During The Day
    id: garden_turn_off_outdoor_lights_if_left_on_during_the_day
    mode: single
    trigger:
      platform: time_pattern
      minutes: '/5' #run every 5 minutes
    condition: #during the day and either light is on
      condition: and
      conditions:
        - condition: state 
          entity_id: sun.sun
          state: 'above_horizon'
        - condition: or
          conditions:
            - condition: state
              entity_id: light.garden_flood_lights
              state: 'on'
              for:
                minutes: 5
            - condition: state
              entity_id:  light.alfresco_ceiling_lights
              state: 'on'
              for:
                minutes: 5
            - condition: state
              entity_id:  light.alfresco_fairy_lights
              state: 'on'
              for:
                minutes: 5
    action:
      - service: light.turn_off
        entity_id: light.alfresco_fairy_lights
      - service: light.turn_off
        entity_id: light.alfresco_ceiling_lights
      - delay: 
          seconds: 10 #Since the alfresco ceiling lights and garden flood lights share the same switch, the light.turn_off requests need to be sent separately with a slight delay
      - service: light.turn_off
        entity_id: light.garden_flood_lights
      - delay:
          minutes: 30 #Don't run the automation again for another half hour, in case there is a legitimate reason for the lights to be on

  #In case I've manually disabled the garden lights switch-off automation, re-enable it when the sun sets for the day
  - alias: Garden - Reactivate Garden Lights Switch-Off Automation Each Day
    id: garden_reactivate_garden_lights_switch_off_automation_each_day
    trigger:
      platform: sun
      event: sunset
    action:
      service: automation.turn_on
      entity_id: automation.garden_turn_off_outdoor_lights_if_left_on_during_the_day

  - alias: Garden - Turn Off Alfresco Fairy Lights If Ceiling Lights Turned On
    id: garden_turn_off_alfresco_fairy_lights_if_ceiling_lights_turned_on
    trigger:
      - platform: state
        entity_id: light.alfresco_ceiling_lights
        to: 'on'
    action:
      service: light.turn_off
      entity_id: light.alfresco_fairy_lights

  - alias: Garden - Turn Off Alfresco Ceiling Lights If Fairy Lights Turned On
    id: garden_turn_off_alfresco_ceiling_lights_if_fairy_lights_turned_on
    trigger:
      - platform: state
        entity_id: light.alfresco_fairy_lights
        to: 'on'
    action:
      service: light.turn_off
      entity_id: light.alfresco_ceiling_lights

  - alias: Garden - Toggle Alfresco Fairy Lights With Switch
    id: garden_toggle_alfresco_fairy_lights_with_switch
    variables: 
      #map the on/off buttons to the appropriate service
      buttons: 
        1002:
          service_to_call: light.turn_on
        2002:
          service_to_call: light.turn_off
    trigger: 
      - platform: event
        event_type: deconz_event
        event_data: 
          id: alfresco_fairy_lights_switch
    condition: 
      - "{{ trigger.event.data.event in buttons }}"
    action:
      - service: "{{ buttons[trigger.event.data.event].service_to_call }}"
        entity_id: light.alfresco_fairy_lights
